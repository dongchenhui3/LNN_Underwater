import pickle
import matplotlib.pyplot as plt
import numpy as np
import os

def visualize_gan_results():
    DATA_PATH = "/home/dong/桌面/LNN-NAV/processed_data/lnn_mag_augmented.pkl"
    OUTPUT_DIR = "/home/dong/桌面/LNN-NAV/plots"
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    print(f"Loading data from {DATA_PATH}...")
    with open(DATA_PATH, 'rb') as f:
        data = pickle.load(f)
        
    # X structure: [Acc(3), Gyro(3), Mag(3), DVL(3), LPF(3)] (Wait, X_list is raw input)
    # Velocity is in Y_vel_body_list
    X_list = data['X_list']
    vel_list = data['Y_vel_body_list']
    
    # Indices 0-6 are Real (7 seqs)
    # Indices 7+ are Augmented
    
    seq_idx = 0 
    aug_idx = 7 # First augmented seq of Seq_00
    
    real_seq = X_list[seq_idx]
    aug_seq = X_list[aug_idx]
    real_vel = vel_list[seq_idx]
    
    # Limit length for clearer plotting
    length = 1000 # 5 seconds
    t = np.arange(length) * 0.005 # 200Hz
    
    # Inputs to GAN
    acc = real_seq[:length, 0:3]
    gyro = real_seq[:length, 3:6]
    vel = real_vel[:length]
    
    # Outputs (Mag)
    mag_real = real_seq[:length, 6:9]
    mag_fake = aug_seq[:length, 6:9]
    
    # 1. Visualization: Mag Comparison (XYZ)
    fig, axes = plt.subplots(3, 1, figsize=(12, 10), sharex=True)
    labels = ['Mag X', 'Mag Y', 'Mag Z']
    
    for i in range(3):
        axes[i].plot(t, mag_real[:, i], label='Real Mag (Original)', color='black', alpha=0.7)
        axes[i].plot(t, mag_fake[:, i], label='Synthetic Mag (GAN)', color='red', alpha=0.7, linestyle='--')
        axes[i].set_ylabel(f"{labels[i]} (Normalized)")
        axes[i].legend(loc='upper right')
        axes[i].grid(True, linestyle=':', alpha=0.6)
        
    axes[2].set_xlabel("Time (s)")
    plt.suptitle("GAN Result: Real vs Synthetic Magnetometer Data\n(Note: Synthetic data has different noise texture but follows similar trend)", fontsize=14)
    plt.tight_layout()
    plt.savefig(f"{OUTPUT_DIR}/gan_mag_comparison.png")
    print(f"Saved comparison plot to {OUTPUT_DIR}/gan_mag_comparison.png")
    
    # 2. Visualization: Input Correlation (Motion -> Noise)
    fig2, axes2 = plt.subplots(5, 1, figsize=(12, 15), sharex=True)
    
    # Input 1: Acc
    axes2[0].plot(t, acc[:, 0], label='Acc X', color='blue')
    axes2[0].plot(t, acc[:, 1], label='Acc Y', color='cyan')
    axes2[0].plot(t, acc[:, 2], label='Acc Z', color='dodgerblue')
    axes2[0].set_title("GAN Input 1: Accelerometer (Motion State)", fontsize=12, fontweight='bold', loc='left')
    axes2[0].legend(loc='upper right')
    axes2[0].grid(True)
    
    # Input 2: Gyro
    axes2[1].plot(t, gyro[:, 0], label='Gyro X', color='green')
    axes2[1].plot(t, gyro[:, 1], label='Gyro Y', color='lime')
    axes2[1].plot(t, gyro[:, 2], label='Gyro Z', color='seagreen')
    axes2[1].set_title("GAN Input 2: Gyroscope (Rotation State)", fontsize=12, fontweight='bold', loc='left')
    axes2[1].legend(loc='upper right')
    axes2[1].grid(True)
    
    # Input 3: Velocity
    axes2[2].plot(t, vel[:, 0], label='Vel X', color='purple')
    axes2[2].plot(t, vel[:, 1], label='Vel Y', color='magenta')
    axes2[2].plot(t, vel[:, 2], label='Vel Z', color='violet')
    axes2[2].set_title("GAN Input 3: Velocity (Speed State)", fontsize=12, fontweight='bold', loc='left')
    axes2[2].legend(loc='upper right')
    axes2[2].grid(True)
    
    # Low pass filter for mag to show noise
    def high_pass(x, w=50):
        return x - np.convolve(x, np.ones(w)/w, mode='same')
        
    noise_real_x = high_pass(mag_real[:, 0])
    noise_fake_x = high_pass(mag_fake[:, 0])
    
    axes2[3].plot(t, noise_real_x, label='Real Mag X High-Freq', color='black', alpha=0.6)
    axes2[3].set_title("Real Magnetic Noise (High-Freq Component)", fontsize=12, fontweight='bold', loc='left')
    axes2[3].legend()
    axes2[3].grid(True)
    
    axes2[4].plot(t, noise_fake_x, label='Synthetic Mag X High-Freq', color='red', alpha=0.6)
    axes2[4].set_title("Synthetic Magnetic Noise (Generated by GAN)", fontsize=12, fontweight='bold', loc='left')
    axes2[4].legend()
    axes2[4].grid(True)
    
    axes2[4].set_xlabel("Time (s)")
    plt.suptitle("GAN Visualisation: Inputs (Motion) -> Output (Synthetic Noise)", fontsize=16)
    plt.tight_layout()
    plt.savefig(f"{OUTPUT_DIR}/gan_inputs_outputs.png")
    print(f"Saved correlation plot to {OUTPUT_DIR}/gan_inputs_outputs.png")

if __name__ == "__main__":
    visualize_gan_results()
